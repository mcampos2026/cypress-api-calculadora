name: ci_api_tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - "feature/**"
      - "CAA-*"
  pull_request:
    branches:
      - main

jobs:
  api_tests:
    runs-on: ubuntu-latest

    env:
      CYPRESS_BASE_URL: "https://dev-calc.azurewebsites.net"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run API tests
        run: npm test

      - name: Prepare evidence zip
        if: always()
        shell: bash
        run: |
          set -e
          mkdir -p evidence

          [ -d cypress/screenshots ] && cp -r cypress/screenshots evidence/ || true
          [ -d cypress/videos ] && cp -r cypress/videos evidence/ || true
          [ -d cypress/results ] && cp -r cypress/results evidence/ || true
          [ -d mochawesome-report ] && cp -r mochawesome-report evidence/ || true
          [ -d reports ] && cp -r reports evidence/ || true
          [ -d cypress/logs ] && cp -r cypress/logs evidence/ || true

          cat > evidence/run.txt <<EOF
          repo=${GITHUB_REPOSITORY}
          workflow=${GITHUB_WORKFLOW}
          run_id=${GITHUB_RUN_ID}
          run_number=${GITHUB_RUN_NUMBER}
          sha=${GITHUB_SHA}
          ref=${GITHUB_REF}
          head_ref=${GITHUB_HEAD_REF}
          ref_name=${GITHUB_REF_NAME}
          run_url=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          EOF

          zip -r "evidence-${GITHUB_RUN_ID}.zip" evidence >/dev/null

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            evidence-*.zip
            evidence/**
            cypress/screenshots/**
            cypress/videos/**
            cypress/results/**
            mochawesome-report/**
            reports/**
            cypress/logs/**
          if-no-files-found: ignore
          retention-days: 7

      - name: Derive Jira issue key from branch/PR
        if: always()
        id: jira_key
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          echo "branch=$BRANCH"

          ISSUE_KEY="$(echo "$BRANCH" | grep -Eo '[A-Z][A-Z0-9]+-[0-9]+' | head -n1 || true)"
          if [ -z "$ISSUE_KEY" ]; then
            echo "Não encontrei issueKey no nome da branch."
            exit 1
          fi

          echo "issueKey=$ISSUE_KEY" >> "$GITHUB_OUTPUT"
          echo "issueKey detectada: $ISSUE_KEY"

      - name: Install jq
        if: always()
        run: sudo apt-get update && sudo apt-get install -y jq

      # ========================
      # FAILURE FLOW
      # ========================
      - name: Create Jira issue (CI Failure)
        if: failure()
        id: jira_issue_fail
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        shell: bash
        run: |
          set -e
          GH_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          payload=$(jq -n \
            --arg key "$JIRA_PROJECT_KEY" \
            --arg summary "[CI] Falha no pipeline - ${GITHUB_REF_NAME}" \
            --arg desc "Falha detectada.\nRun: ${GH_RUN_URL}\nRepo: ${GITHUB_REPOSITORY}\nBranch: ${GITHUB_REF_NAME}\nCommit: ${GITHUB_SHA}" \
            '{
              fields: {
                project: { key: $key },
                summary: $summary,
                description: {
                  type: "doc",
                  version: 1,
                  content: [
                    { type: "paragraph", content: [ { type: "text", text: $desc } ] }
                  ]
                },
                issuetype: { name: "Task" }
              }
            }')

          RESP=$(curl -sS -X POST \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue" \
            -d "$payload")

          ISSUE_KEY_CREATED=$(echo "$RESP" | jq -r '.key')
          if [ -z "$ISSUE_KEY_CREATED" ] || [ "$ISSUE_KEY_CREATED" = "null" ]; then
            echo "Erro ao criar issue. Resposta Jira: $RESP"
            exit 1
          fi

          echo "issueKey=$ISSUE_KEY_CREATED" >> "$GITHUB_OUTPUT"
          echo "Issue criada: $ISSUE_KEY_CREATED"

      - name: Attach evidence to Jira (failure)
        if: failure()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ steps.jira_issue_fail.outputs.issueKey }}
        shell: bash
        run: |
          set -e
          ZIP_FILE="evidence-${GITHUB_RUN_ID}.zip"
          GH_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          ATTACH_JSON="$(curl -sS -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}?fields=attachment,labels")"

          # Label ci-failure (sem duplicar)
          LABELS_UPDATED="$(echo "$ATTACH_JSON" | jq -c '
            (.fields.labels // []) as $l
            | (if ($l | index("ci-failure")) then $l else ($l + ["ci-failure"]) end)
          ')"

          curl -sS -X PUT \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}" \
            -d "$(jq -n --argjson labels "$LABELS_UPDATED" '{fields:{labels:$labels}}')" \
            >/dev/null

          has_attachment () {
            local filename="$1"
            echo "$ATTACH_JSON" | jq -e --arg fn "$filename" '.fields.attachment[]? | select(.filename==$fn)' >/dev/null 2>&1
          }

          # Anexa zip (sem duplicar)
          if [ -f "$ZIP_FILE" ]; then
            if has_attachment "$(basename "$ZIP_FILE")"; then
              echo "Zip já anexado no Jira: $ZIP_FILE (skip)"
            else
              curl -sS -X POST \
                -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
                -H "X-Atlassian-Token: no-check" \
                -F "file=@${ZIP_FILE}" \
                "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/attachments" \
                >/dev/null
            fi
          fi

          # Anexa vídeos mp4 (nomeados com run_id, sem duplicar)
          if ls cypress/videos/*.mp4 >/dev/null 2>&1; then
            for f in cypress/videos/*.mp4; do
              base="$(basename "$f" .mp4)"
              tmp="${base}-${GITHUB_RUN_ID}.mp4"
              cp "$f" "$tmp"

              if has_attachment "$tmp"; then
                echo "Video já anexado no Jira: $tmp (skip)"
              else
                echo "Anexando video: $tmp"
                curl -sS -X POST \
                  -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
                  -H "X-Atlassian-Token: no-check" \
                  -F "file=@${tmp}" \
                  "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/attachments" \
                  >/dev/null
              fi
            done
          else
            echo "Nenhum video mp4 encontrado em cypress/videos"
          fi

          echo "Falha registrada em ${ISSUE_KEY} | Run: ${GH_RUN_URL}"

      - name: Comment Jira issue (failure)
        if: failure()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ steps.jira_issue_fail.outputs.issueKey }}
        shell: bash
        run: |
          set -e
          GH_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          COMMENT=$(jq -n \
            --arg txt "❌ CI FALHOU\nRun: ${GH_RUN_URL}\nArtifact: cypress-artifacts\nRepo: ${GITHUB_REPOSITORY}\nBranch: ${GITHUB_REF_NAME}\nCommit: ${GITHUB_SHA}" \
            '{
              body: {
                type: "doc",
                version: 1,
                content: [
                  { type: "paragraph", content: [ { type: "text", text: $txt } ] }
                ]
              }
            }')

          curl -sS -X POST \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/comment" \
            -d "$COMMENT" \
            >/dev/null

      # ========================
      # SUCCESS FLOW
      # ========================
      - name: Attach evidence + comment to Jira issue (success)
        if: success()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ steps.jira_key.outputs.issueKey }}
        shell: bash
        run: |
          set -e
          ZIP_FILE="evidence-${GITHUB_RUN_ID}.zip"
          GH_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          ISSUE_JSON="$(curl -sS -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}?fields=attachment,labels")"

          # Label ci-success (sem duplicar)
          LABELS_UPDATED="$(echo "$ISSUE_JSON" | jq -c '
            (.fields.labels // []) as $l
            | (if ($l | index("ci-success")) then $l else ($l + ["ci-success"]) end)
          ')"

          curl -sS -X PUT \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}" \
            -d "$(jq -n --argjson labels "$LABELS_UPDATED" '{fields:{labels:$labels}}')" \
            >/dev/null

          has_attachment () {
            local filename="$1"
            echo "$ISSUE_JSON" | jq -e --arg fn "$filename" '.fields.attachment[]? | select(.filename==$fn)' >/dev/null 2>&1
          }

          # Anexa zip (sem duplicar)
          if [ -f "$ZIP_FILE" ]; then
            if has_attachment "$(basename "$ZIP_FILE")"; then
              echo "Zip já anexado no Jira: $ZIP_FILE (skip)"
            else
              curl -sS -X POST \
                -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
                -H "X-Atlassian-Token: no-check" \
                -F "file=@${ZIP_FILE}" \
                "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/attachments" \
                >/dev/null
            fi
          fi

          # Anexa vídeos mp4 (nomeados com run_id, sem duplicar)
          if ls cypress/videos/*.mp4 >/dev/null 2>&1; then
            for f in cypress/videos/*.mp4; do
              base="$(basename "$f" .mp4)"
              tmp="${base}-${GITHUB_RUN_ID}.mp4"
              cp "$f" "$tmp"

              if has_attachment "$tmp"; then
                echo "Video já anexado no Jira: $tmp (skip)"
              else
                echo "Anexando video: $tmp"
                curl -sS -X POST \
                  -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
                  -H "X-Atlassian-Token: no-check" \
                  -F "file=@${tmp}" \
                  "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/attachments" \
                  >/dev/null
              fi
            done
          else
            echo "Nenhum video mp4 encontrado em cypress/videos"
          fi

          # Comentário
          COMMENT=$(jq -n \
            --arg txt "✅ CI SUCESSO\nRun: ${GH_RUN_URL}\nRepo: ${GITHUB_REPOSITORY}\nBranch: ${GITHUB_REF_NAME}\nCommit: ${GITHUB_SHA}" \
            '{
              body: {
                type: "doc",
                version: 1,
                content: [
                  { type: "paragraph", content: [ { type: "text", text: $txt } ] }
                ]
              }
            }')

          curl -sS -X POST \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/comment" \
            -d "$COMMENT" \
            >/dev/null

          # Transição para Done (se existir)
          TRANSITIONS="$(curl -sS -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/transitions")"

          TRANSITION_ID="$(echo "$TRANSITIONS" | jq -r '
            .transitions[]
            | select(.name == "Done")
            | .id
          ' | head -n1)"

          if [ -n "$TRANSITION_ID" ] && [ "$TRANSITION_ID" != "null" ]; then
            curl -sS -X POST \
              -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "${JIRA_BASE_URL}/rest/api/3/issue/${ISSUE_KEY}/transitions" \
              -d "$(jq -n --arg id "$TRANSITION_ID" '{transition:{id:$id}}')" \
              >/dev/null
            echo "Issue transicionada para Done"
          else
            echo "Transição Done não encontrada. Mantendo status atual."
          fi
